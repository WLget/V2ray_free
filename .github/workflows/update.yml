name: 每日Gist同步与README更新

# 触发器：
on:
    # 1. 每日定时触发 (UTC 时间 01:00，即北京时间 09:00 AM)
  # schedule:
    # cron 格式: 分 时 日 月 周
    # - cron: '0 1 * * *'
  # 2. 允许手动触发，方便测试
  workflow_dispatch:

# 环境变量配置
env:
  GITHUB_USERNAME: "WLget" 
  GIST_ID: "aeb222e378a8dcbd74e06413dbacf400" 
  GIST_FILENAME: "base64.txt" 
  TARGET_FILE: "temp_gist_content.txt" # 临时存储 Gist 内容的文件
  README_FILE: "README.md"
  
jobs:
  sync_and_update:
    name: 同步 Gist 内容并更新 README
    runs-on: ubuntu-latest
    
    # 授予工作流写入权限，以便提交文件
    permissions:
      contents: write
      
    steps:
      # 1. 检出仓库代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置动态日期
      - name: 设置动态日期
        id: set_vars
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "date=$DATE" >> $GITHUB_OUTPUT

      # 3. 获取 Gist 内容并写入本地临时文件
      - name: 获取 Gist 内容
        run: |
          GIST_URL="https://gist.githubusercontent.com/${{ env.GITHUB_USERNAME }}/${{ env.GIST_ID }}/raw/${{ env.GIST_FILENAME }}"
          curl -sL "$GIST_URL" > ${{ env.TARGET_FILE }}
          
          if [ ! -s ${{ env.TARGET_FILE }} ]; then
            echo "错误：未能获取Gist内容或文件为空。"
            exit 1
          fi

      # 4. 更新 README.md 文件，将 Gist 内容插入到指定标记之间，并用代码块包裹
      - name: 插入内容到 README.md (使用代码块)
        run: |
          # 定义标记
          START_MARKER="<!-- GIST_CONTENT_START -->"
          END_MARKER="<!-- GIST_CONTENT_END -->"
          
          # 使用 AWK 脚本替换标记之间的内容，并添加代码块标记 (```)
          awk -v start="$START_MARKER" -v end="$END_MARKER" -v content_file="${{ env.TARGET_FILE }}" '
            $0 ~ start {
              print; 
              print "```"; # 添加起始代码块标记
              # 插入 Gist 内容
              while ((getline content < content_file) > 0) {
                print content
              }
              print "```"; # 添加结束代码块标记
              in_block=1; 
              next
            }
            $0 ~ end {
              print; 
              in_block=0; 
              next
            }
            !in_block {print}
          ' ${{ env.README_FILE }} > README.tmp
          
          if [ $? -eq 0 ]; then
            mv README.tmp ${{ env.README_FILE }}
            echo "README.md 更新成功。"
          else
            echo "错误：awk 脚本执行失败。"
            exit 1
          fi
          
          # 清理临时文件
          rm ${{ env.TARGET_FILE }}

      # 5. 提交更改
      - name: 提交更新后的 README
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "每天自动同步Gist内容并更新README，日期：${{ steps.set_vars.outputs.date }}"
          file_pattern: "${{ env.README_FILE }}"
          branch: master # <-- 请根据您的实际主分支名称修改此处
