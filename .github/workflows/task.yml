name: Gist 内容同步与日志

on:
  schedule:
    - cron: '0 */4 * * *'
  
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发同步的原因'
        required: false
        default: '手动执行'

jobs:
  sync_content:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 执行同步脚本
        env:
          GIST_RAW_URL: ${{ secrets.GIST_RAW_URL }} 
        run: |
          # --------------------------------------------------
          # 1. 设置变量
          # --------------------------------------------------
          README_FILE="README.md"
          SYNC_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          SYNC_DATE=$(date "+%Y-%m-%d")
          
          if [ -z "$GIST_RAW_URL" ]; then
            echo "错误：GIST_RAW_URL 未设置。"
            exit 1
          fi

          # --------------------------------------------------
          # 2. 获取 Gist 内容并判断状态
          # --------------------------------------------------
          echo "正在从 Gist 获取内容..."
          GIST_CONTENT=$(curl -sL "$GIST_RAW_URL")

          if [ -z "$GIST_CONTENT" ]; then
            echo "警告：Gist 内容为空或获取失败。"
            SYNC_STATUS="节点分享失败（内容为空）"
            GIST_CONTENT_BLOCK="获取内容失败或内容为空。"
          else
            SYNC_STATUS="节点分享成功"
            GIST_CONTENT_BLOCK="$GIST_CONTENT"
          fi

          # --------------------------------------------------
          # 3. 更新 README.md 内容部分 (内容替换和格式化)
          # --------------------------------------------------
          
          START_MARKER="<!-- GIST_SYNC_START -->"
          END_MARKER="<!-- GIST_SYNC_END -->"
          
          # 构造包含 HTML 滚动框和 Markdown 代码块的新内容
          # max-height: 200px 大约是 10 行的高度
          NEW_CONTENT=$(cat <<EOF
$START_MARKER
<details>
<summary>点击展开最新同步内容 ($SYNC_TIME)</summary>
<div style="max-height: 200px; overflow: auto; border: 1px solid #ccc; padding: 10px;">

\`\`\`
$GIST_CONTENT_BLOCK
\`\`\`

</div>
</details>
$END_MARKER
EOF
)
          
          # 准备要插入的内容 (转义换行符，以便 sed 'a' 命令使用)
          # 注意：这里我们使用 printf 而不是 echo -e 来更可靠地处理转义
          # 移除 START_MARKER 和 END_MARKER 标记本身，只保留中间内容
          INSERT_CONTENT=$(echo "$NEW_CONTENT" | sed '1d;$d')
          INSERT_CONTENT_ESCAPED=$(printf "%s" "$INSERT_CONTENT" | sed -e 's/\\/\\\\/g' -e ':a' -e 'N' -e '$!ba' -e 's/\n/\\n/g')

          # 步骤 3.1: 删除 START_MARKER 和 END_MARKER 之间的所有内容 (不包括标记本身)
          # /START_MARKER/,/END_MARKER/ 定位区块，然后用 d 删除中间行
          sed -i "/$START_MARKER/,/$END_MARKER/{ /$START_MARKER/! { /$END_MARKER/! d } }" "$README_FILE"
          
          # 步骤 3.2: 在 START_MARKER 后面插入新的内容
          # 使用 sed 'a\' (append) 命令
          sed -i "/$START_MARKER/a\\$INSERT_CONTENT_ESCAPED" "$README_FILE"
          
          echo "Gist 内容已成功替换到标记区域并应用滚动样式。"


          # --------------------------------------------------
          # 4. 更新同步日志表格 (每日只记录一次)
          # --------------------------------------------------
          
          LOG_HEADER="| 同步时间 | 同步状态 |"
          LOG_SEPARATOR="| :--- | :--- |"
          LOG_ENTRY="| $SYNC_TIME | $SYNC_STATUS |"
          LOG_MARKER="<!-- SYNC_LOG_TABLE -->"
          
          # 检查 README.md 中是否已存在今天的日志记录
          # 查找 LOG_SEPARATOR 行，并在其后的内容中查找今天的日期
          if awk '/| :--- | :--- |/ { p=1 } p && $0 ~ /'$SYNC_DATE'/ { exit 1 }' "$README_FILE"; then
            echo "今天 ($SYNC_DATE) 的日志已存在，跳过记录。"
          else
            echo "今天 ($SYNC_DATE) 没有日志记录，正在写入新条目。"
            
            # 检查日志标记是否存在 (理论上 Step 1 已经确保了存在)
            if ! grep -q "$LOG_MARKER" "$README_FILE"; then
              echo "警告：未找到日志标记，跳过日志写入。"
            else
              # 在分隔符后插入新的日志条目 (最新的在最上面)
              awk -v entry="$LOG_ENTRY" '/| :--- | :--- |/ {print; print entry; next} 1' "$README_FILE" > temp && mv temp "$README_FILE"
            fi
          fi

          # --------------------------------------------------
          # 5. 提交更改
          # --------------------------------------------------
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --exit-code "$README_FILE"; then
            echo "README.md 没有变化，无需提交。"
          else
            git add "$README_FILE"
            
            COMMIT_MESSAGE="自动同步 Gist 内容和更新日志：$SYNC_TIME"
            if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                COMMIT_MESSAGE="${COMMIT_MESSAGE} (手动触发)"
            fi
            
            git commit -m "${COMMIT_MESSAGE}"
            # 推送到 master 分支
            git push https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git HEAD:master
            echo "成功提交并推送更改。"
          fi
